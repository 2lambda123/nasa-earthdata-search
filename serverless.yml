service: earthdata-search

provider:
  name: aws
  runtime: nodejs8.10
  versionFunctions: false
  stage: ${opt:stage, 'lab'}
  region: us-east-1
  endpointType: PRIVATE
  memorySize: 256
  environment:
    dbEndpoint:
      Fn::GetAtt:
        - Database
        - Endpoint.Address
    dbPort:
      Fn::GetAtt:
        - Database
        - Endpoint.Port
    dbUsername: edsc
    dbName: edsc_${self:provider.stage}

    colorMapQueueUrl:
      Ref: ColorMapsProcessingQueue
    tagQueueUrl:
      Ref: TagProcessingQueue
    legacyServicesQueueUrl:
      Ref: LegacyServicesOrderQueue
    catalogRestQueueUrl:
      Ref: CatalogRestOrderQueue
    optionDefinitionQueueUrl:
      Ref: OptionDefinitionsQueue

    configSecretId:
      Ref: DbPasswordSecret

    storeUserLambda: ${self:custom.siteName}-storeUserData
    collectionCapabilitiesLambda: ${self:custom.siteName}-generateCollectionCapabilityTags

  vpc:
    securityGroupIds:
      - Ref: LambdaSecurityGroup
    subnetIds:
      - ${self:custom.awsResources.subnet.a}
      - ${self:custom.awsResources.subnet.b}
  role: ScheduledLambdaRole

plugins:
  - serverless-finch
  - serverless-plugin-warmup
  - serverless-offline
  - serverless-webpack

#
# Lambda Functions
#
functions:
  #
  # Standalone functions
  #
  migrateDatabase:
    handler: serverless/src/migrateDatabase/handler.default
    timeout: 300
    webpack:
      includeMigrations: true
    warmup:
      enabled: false

  storeUserData:
    timeout: 300
    handler: serverless/src/storeUserData/handler.default
    warmup:
      concurrency: 3

  #
  # SQS Lambdas
  #
  processColorMap:
    handler: serverless/src/processColorMap/handler.default
    timeout: 300
    receiveMessageWaitTimeSeconds: 30
    reservedConcurrency: 25
    warmup:
      enabled: false
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - ColorMapsProcessingQueue
              - Arn

  processTag:
    handler: serverless/src/processTag/handler.default
    timeout: 300
    receiveMessageWaitTimeSeconds: 30
    reservedConcurrency: 25
    warmup:
      enabled: false
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - TagProcessingQueue
              - Arn

  # We need to limit the concurrency on this lambda due to a call to Legacy Services
  # within it. Putting too much load on the endpoint will cause production systems to fail
  fetchOptionDefinitions:
    handler: serverless/src/fetchOptionDefinitions/handler.default
    timeout: 300
    reservedConcurrency: 5
    warmup:
      enabled: false
    events:
      - sqs:
          batchSize: 5
          arn:
            Fn::GetAtt:
              - OptionDefinitionsQueue
              - Arn

  submitCatalogRestOrder:
    handler: serverless/src/submitCatalogRestOrder/handler.default
    timeout: 600
    warmup:
      enabled: false
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - CatalogRestOrderQueue
              - Arn

  submitLegacyServicesOrder:
    handler: serverless/src/submitLegacyServicesOrder/handler.default
    timeout: 600
    warmup:
      enabled: false
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - LegacyServicesOrderQueue
              - Arn

  #
  # Scheduled Lambdas
  #
  generateColorMaps:
    handler: serverless/src/generateColorMaps/handler.default
    description: Gather Color Map data from GIBS and store it in RDS
    timeout: 300
    warmup:
      enabled: false
    events:
      - schedule:
          rate: cron(0 5 * * ? *)
          enabled: false
          input:
            projection: 'epsg4326'
      - schedule:
          rate: cron(5 5 * * ? *)
          enabled: false
          input:
            projection: 'epsg3857'
      - schedule:
          rate: cron(10 5 * * ? *)
          enabled: false
          input:
            projection: 'epsg3413'
      - schedule:
          rate: cron(15 5 * * ? *)
          enabled: false
          input:
            projection: 'epsg3031'

  generateGibsTags:
    handler: serverless/src/generateGibsTags/handler.default
    description: Tag CMR collections with GIBS product information
    timeout: 300
    warmup:
      enabled: false
    events:
      - schedule:
          rate: cron(0 * * * ? *)
          enabled: false

  generateSubsettingTags:
    handler: serverless/src/generateSubsettingTags/handler.default
    description: Tag CMR collections with umm service subsetting information
    timeout: 300
    warmup:
      enabled: false
    events:
      - schedule:
          rate: cron(0 5 * * ? *)
          enabled: false

  generateCollectionCapabilityTags:
    handler: serverless/src/generateCollectionCapabilityTags/handler.default
    description: Iterate over all CMR collections adding tags specific to EDSC
    timeout: 300
    warmup:
      enabled: false
    events:
      - schedule:
          rate: cron(0 6 * * ? *)
          enabled: false
          input:
            pageNumber: 1
            perPage: 2000

  #
  # API Gateway Endpoints
  #
  getColorMap:
    handler: serverless/src/getColorMap/handler.default
    warmup:
      enabled: false
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: colormaps/{product}

  cwicGranuleSearch:
    handler: serverless/src/cwicGranuleSearch/handler.default
    warmer:
      concurrency: 3
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: cwic/granules

  nlpSearch:
    handler: serverless/src/nlpSearch/handler.default
    memorySize: 128
    warmer:
      concurrency: 3
    events:
      - http:
          method: post
          cors:
            origin : '*'
          path: nlp

  conceptMetadata:
    handler: serverless/src/conceptMetadata/handler.default
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: concepts/metadata

  saveShapefile:
    handler: serverless/src/saveShapefile/handler.default
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: shapefiles

  edlLogin:
    handler: serverless/src/edlLogin/handler.default
    warmup:
      concurrency: 3
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: login

  edlCallback:
    handler: serverless/src/edlCallback/handler.default
    warmup:
      concurrency: 3
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: urs_callback

  edlAuthorizer:
    handler: serverless/src/edlAuthorizer/handler.default
    warmer:
      concurrency: 3
    cors:
      origin: '*'

  #
  # EDL Authenticated API Gateway Endpoints
  #

  retrieveConcept:
    handler: serverless/src/retrieveConcept/handler.default
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: concepts/{id}
          authorizer: edlAuthorizer
          request:
            parameters:
              paths:
                id: true

  collectionSearch:
    handler: serverless/src/collectionSearch/handler.default
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: collections/{format}
          request:
            parameters:
              paths:
                format: true
          authorizer: edlAuthorizer

  cmrGranuleSearch:
    handler: serverless/src/cmrGranuleSearch/handler.default
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: granules
          authorizer: edlAuthorizer

  timelineSearch:
    handler: serverless/src/timelineSearch/handler.default
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: granules/timeline
          authorizer: edlAuthorizer

  submitOrder:
    handler: serverless/src/submitOrder/handler.default
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: orders
          authorizer: edlAuthorizer

  getRetrieval:
    handler: serverless/src/getRetrieval/handler.default
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: retrievals/{retrieval_id}
          authorizer: edlAuthorizer

  getRetrievalCollection:
    handler: serverless/src/getRetrievalCollection/handler.default
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: retrievals/{retrieval_id}/collections/{collection_id}
          authorizer: edlAuthorizer

  getRetrievalCollections:
    handler: serverless/src/getRetrievalCollections/handler.default
    events:
      - http:
          method: get
          cors:
            origin: '*'
          path: retrievals/{retrieval_id}/collections
          authorizer: edlAuthorizer

  getAccessMethods:
    handler: serverless/src/getAccessMethods/handler.default
    events:
      - http:
          method: post
          cors:
            origin: '*'
          path: access_methods
          authorizer: edlAuthorizer

#
# Additional AWS Resources
#
resources:
  # A method to include environment specific resources
  # Resources: ${file(./resources-${self:provider.stage}.yml)}
  Resources:
    # SQS Queue to process Color Map entries
    ColorMapsProcessingQueue:
      Type: 'AWS::SQS::Queue'
      Properties:
        MessageRetentionPeriod: 345600 # Default value, leaving for visibility
        VisibilityTimeout: 300

    TagProcessingQueue:
      Type: 'AWS::SQS::Queue'
      Properties:
        VisibilityTimeout: 300

    LegacyServicesOrderQueue:
      Type: 'AWS::SQS::Queue'
      Properties:
        VisibilityTimeout: 600
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - LegacyServicesOrderDeadLetterQueue
              - Arn
          maxReceiveCount: 2 # Number of times a message will be tried before being dumped to the DLQ

    LegacyServicesOrderDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.siteName}-LegacyServicesOrderDeadLetterQueue
        MessageRetentionPeriod: 1209600

    CatalogRestOrderQueue:
      Type: 'AWS::SQS::Queue'
      Properties:
        VisibilityTimeout: 600 # Give orders a full day to complete
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - CatalogRestOrderDeadLetterQueue
              - Arn
          maxReceiveCount: 2 # Number of times a message will be tried before being dumped to the DLQ

    CatalogRestOrderDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.siteName}-CatalogRestOrderDeadLetterQueue
        MessageRetentionPeriod: 1209600

    OptionDefinitionsQueue:
      Type: 'AWS::SQS::Queue'
      Properties:
        VisibilityTimeout: 3600
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - OptionDefinitionDeadLetterQueue
              - Arn
          maxReceiveCount: 2 # Number of times a message will be tried before being dumped to the DLQ

    OptionDefinitionDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.siteName}-OptionDefinitionDeadLetterQueue
        MessageRetentionPeriod: 1209600

    LambdaSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
        GroupDescription: 'Security Group for EDSC Lambda functions'
        SecurityGroupEgress:
          - CidrIp: '0.0.0.0/0'
            IpProtocol: -1
            FromPort: 0
            ToPort: 65535
        VpcId: ${self:custom.awsResources.vpc}

    # Database password secret storage
    DbPasswordSecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Description: "EDSC RDS database master password"
        GenerateSecretString:
          SecretStringTemplate: "{\"username\":\"edsc\"}"
          GenerateStringKey: "password"
          PasswordLength: 30
          ExcludeCharacters: "\"@/\\"

    SecretRDSInstanceAttachment:
      Type: "AWS::SecretsManager::SecretTargetAttachment"
      Properties:
        SecretId:
          Ref: DbPasswordSecret
        TargetId:
          Ref: Database
        TargetType: AWS::RDS::DBInstance

    # RDS database
    Database:
      Type: AWS::RDS::DBInstance
      Properties:
        DBName: edsc_${self:provider.stage}
        AllocatedStorage: '20'
        DBInstanceClass: db.t2.micro
        Engine: postgres
        EngineVersion: '10.6'
        MasterUsername: {"Fn::Join": ["", ["{{resolve:secretsmanager:",{"Ref": "DbPasswordSecret"},":SecretString:username}}"] ] }
        MasterUserPassword: {"Fn::Join": ["", ["{{resolve:secretsmanager:",{"Ref": "DbPasswordSecret"},":SecretString:password}}"] ] }
        StorageType: gp2
        DBSubnetGroupName:
          Ref: DBSubnetGroup
        VPCSecurityGroups:
          - Ref: DatabaseVpcSecurityGroup

    DBSubnetGroup:
      Type: 'AWS::RDS::DBSubnetGroup'
      Properties:
        DBSubnetGroupDescription: EDSC DB subnet group
        SubnetIds:
          - ${self:custom.awsResources.subnet.a}
          - ${self:custom.awsResources.subnet.b}

    DatabaseVpcSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
        GroupDescription: Allow Lambdas to access database
        SecurityGroupIngress:
          - SourceSecurityGroupId:
              Ref: LambdaSecurityGroup
            IpProtocol: tcp
            FromPort: 5432
            ToPort: 5432
        VpcId: ${self:custom.awsResources.vpc}

    # Merge the NGAP PermissionsBoundary into the
    # default (Serverless Defined) role for executing Lambdas
    # IamRoleLambdaExecution:
    #   Type: "AWS::IAM::Role"
    #   Properties:
    #     PermissionsBoundary:
    #       Fn::Join: [
    #         "", [
    #           "arn:aws:iam::",
    #           {
    #             "Ref": "AWS::AccountId"
    #           },
    #           ":policy/NGAPShNonProdRoleBoundary"
    #         ]
    #       ]
    #     AssumeRolePolicyDocument:
    #       Version: '2012-10-17'
    #       Statement:
    #         - Effect: Allow
    #           Principal:
    #             Service:
    #               - lambda.amazonaws.com
    #           Action: sts:AssumeRole

    ScheduledLambdaRole:
      Type: "AWS::IAM::Role"
      Properties:
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        PermissionsBoundary:
          Fn::Join: [
            "", [
              "arn:aws:iam::",
              {
                "Ref": "AWS::AccountId"
              },
              ":policy/NGAPShNonProdRoleBoundary"
            ]
          ]
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: RDSIAMAuthentication
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - rds-db:connect
                  Resource:
                    Fn::Join: [
                      "", [
                          "arn:aws:rds-db:",
                          {
                            "Ref": "AWS::Region"
                          },
                          ":",
                          {
                            "Ref": "AWS::AccountId"
                          },
                          ":dbuser",
                          "/lambda"
                      ]
                    ]
          - PolicyName: EDSCLambdaBase
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - sqs:*
                  Resource: "*"
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                  Resource: "*"
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                  Resource: "*"

    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: ApiGatewayRestApi

    GatewayResponseDefault5XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: DEFAULT_5XX
        RestApiId:
          Ref: ApiGatewayRestApi

# Package each lambda into individual zip files. This reduces the size of
# each lambda but increases the complexity of the compilation process slightly
package:
  individually: true

custom:
  siteName: earthdata-search-${self:provider.stage}

  awsResources:
    vpc: ${env:VPC_ID}
    subnet:
      a: ${env:SUBNET_ID_A}
      b: ${env:SUBNET_ID_B}

  # Finch (S3 sync plugin)
  client:
    bucketName: ${self:custom.siteName}
    distributionFolder: static/dist

    # Prevent the plugin from attempting to change the bucket policy
    manageResources: false

  # Default is 3000 so to avoid conflicts with rails applications we'll define a new port
  serverless-offline:
    port: 3001

  # Serverless Webpack configurations
  webpack:
    webpackConfig: 'serverless.webpack.config.js'
    includeModules: true
    packager: 'npm'
    excludeFiles: src/**/*.test.js

  warmup:
    enabled: true
    role: ScheduledLambdaRole
    prewarm: true
    timeout: 30
    events: 
      - schedule: 'cron(0/20 8-22 ? * MON-FRI *)'
